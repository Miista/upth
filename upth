# !/bin/bash

UPLINK=${HOME}/Library/Application\ Support/Uplink
MODS=${UPLINK}/mods
GRAPHICS=${UPLINK}/mods/graphics
STEAM=${HOME}/Library/Application\ Support/Steam/steamapps/common/Uplink/Uplink.app/Contents/Resources/

# {{{ Checks

function check_symlinks() {
  if [ ! -L "$STEAM"/data ]; then
    ln -s "$MODS"/data/ "$STEAM"
  fi

  if [ ! -L "$STEAM"/graphics ]; then
    ln -s "$MODS"/graphics/ "$STEAM"
  fi

  if [ ! -L "$STEAM"/sounds ]; then
    ln -s "$MODS"/sounds/ "$STEAM"
  fi

  if [ ! -L "$STEAM"/music ]; then
    ln -s "$MODS"/music/ "$STEAM"
  fi
}

function check_uplink_folder() {
  if [ ! -d "$UPLINK"  ];
    then echo "Uplink folder does not exist";
    exit 1;
  fi
}

function check_mods_folder() {
  if [ ! -d "$GRAPHICS"  ];
    then echo "Graphics folder does not exist";
    exit 1;
  fi
}

# }}}

# {{{ Ask

ask() {
    # http://djm.me/ask
    local prompt default REPLY

    while true; do

        if [ "${2:-}" = "Y" ]; then
            prompt="Y/n"
            default=Y
        elif [ "${2:-}" = "N" ]; then
            prompt="y/N"
            default=N
        else
            prompt="y/n"
            default=
        fi

        # Ask the question (not using "read -p" as it uses stderr not stdout)
        echo -n "$1 [$prompt] "

        # Read the answer (use /dev/tty in case stdin is redirected from somewhere else)
        read REPLY </dev/tty

        # Default?
        if [ -z "$REPLY" ]; then
            REPLY=$default
        fi

        # Check if the reply is valid
        case "$REPLY" in
            Y*|y*) return 0 ;;
            N*|n*) return 1 ;;
        esac

    done
}

# }}}

# {{{ Install

install_theme() {
  if [ -f "$GRAPHICS/theme.txt" ]; then
    echo "Another theme already installed. Use replace instead.";
    exit 1
  fi

  if confirm_location $1; then
    silent_install $1;
    echo "Theme installed!"
    exit 0
  fi
}

silent_install() {
  loc=$1/*
  cp -nR $loc /Users/palmund/Library/Application\ Support/Uplink/mods/graphics
}

# }}}

confirm_location() {
  echo "Install from here: $1"
  ask "Confirm" Y; # Default to YES
}

# {{{ Restore

restore_theme() {
  paths=$(pwd)/paths.txt
  files=$(cat $paths)
  for f in $files
  do
    if [ -f "$GRAPHICS/$f" ]; then
      file="$GRAPHICS"/$f
      rm "$file"
    fi
  done

  echo "Default theme restored!"
}

# }}}

# {{{ Replace

replace_theme() {
  if [ ! -f "$GRAPHICS/theme.txt" ]; then
    echo "No theme installed to replace. Use install instead.";
    exit 0
  fi

  if confirm_location $1; then
    restore_theme && silent_install $1
  fi
}

# }}}

check_uplink_folder &&
  check_mods_folder &&
  check_symlinks;

if [ "$1" == "install" ]; then
  shift # Remove command from argument list
  install_theme $1
elif [ "$1" == "restore" ]; then
  restore_theme
elif [ "$1" == "replace" ]; then
  shift # Remove command from argument list
  replace_theme $1
elif [ "$1" == "rebuild" ]; then
  path=$(dirname $(readlink $0))
  bash ${path}/list
else
  echo "I don't understand what you want.";
  exit 1
fi
